<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle Pass</title>
    <link rel="stylesheet" href="/css/battlepass.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" referrerpolicy="no-referrer">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
    <header class="top-nav">
        <div class="nav-left">
            <span class="logo-text">StreamFlix</span>
        </div>
        <div class="nav-right">
            <a href="/points-info" class="nav-icon"><i class="fa-solid fa-info-circle"></i> Points Info</a>
            <ul class="nav-menu">
                <li><a href="/home"><i class="fa-solid fa-house"></i> Home</a></li>
                <li><a href="/shop"><i class="fa-solid fa-cart-shopping"></i> Shop</a></li>
                <li><a href="/login"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></li>
            </ul>
            <span class="nav-icon" id="points">
                Points: <span th:text="${loggedUser != null ? loggedUser.points : 0}">0</span>
            </span>
        </div>
    </header>
    <section class="banner">
        <div class="banner-content">
            <h1>Battle Pass Rewards</h1>
            <p>Unlock exclusive rewards as you progress through the tiers!</p>
        </div>
    </section>
    <div class="battle-pass-container">
        <div class="progress-bar-container">
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progress-bar-fill" 
                     th:style="'width: ' + (${loggedUser != null and loggedUser.exp != null ? (loggedUser.exp / 1000) * 100 : 0}) + '%'"></div>
                <span class="progress-value" id="progress-value" 
                      th:text="${loggedUser != null and loggedUser.exp != null ? loggedUser.exp : 0} + ' / 1000'">0 / 1000</span>
            </div>
            <div class="tier-number" id="tier-number">Tier 1</div>
            <p id="progress-summary">Unlocked Tiers: 0 / 10</p>
        </div>
        <div class="tier-progress-horizontal">
            <div class="tier">
                <button class="reward" onclick="claimReward(1)">
                    <img src="/images/reward1.png" alt="Reward 1">
                </button>
                <button class="reward" onclick="claimReward(2)">
                    <img src="/images/reward2.png" alt="Reward 2">
                </button>
                <button class="reward" onclick="claimReward(3)">
                    <img src="/images/reward3.png" alt="Reward 3">
                </button>
                <button class="reward" onclick="claimReward(4)">
                    <img src="/images/reward4.png" alt="Reward 4">
                </button>
                <button class="reward" onclick="claimReward(5)">
                    <img src="/images/reward5.png" alt="Reward 5">
                </button>
                <button class="reward" onclick="claimReward(6)">
                    <img src="/images/reward6.png" alt="Reward 6">
                </button>
                <button class="reward" onclick="claimReward(7)">
                    <img src="/images/reward7.png" alt="Reward 7">
                </button>
                <button class="reward" onclick="claimReward(8)">
                    <img src="/images/reward8.png" alt="Reward 8">
                </button>
                <button class="reward" onclick="claimReward(9)">
                    <img src="/images/reward9.png" alt="Reward 9">
                </button>
                <button class="reward" onclick="claimReward(10)">
                    <img src="/images/reward10.png" alt="Reward 10">
                </button>
            </div>
        </div>
    </div>
    <div class="missions-container">
        <h2>Daily Missions</h2>
        <div class="missions-grid">
            <div class="mission-card">
                <span>Daily Login</span>
                <p>10 xp</p>
                <button onclick="completeMission('DailyLogin', 10)">Complete</button>
            </div>
            <div class="mission-card">
                <span>Watch 3 Movies</span>
                <p>50 xp</p>
                <button onclick="completeMission('Watch3Movies', 50)">Complete</button>
            </div>
            <div class="mission-card">
                <span>Buy something</span>
                <p>75 xp</p>
                <button onclick="completeMission('BuySomething', 75)">Complete</button>
            </div>
            <div class="mission-card">
                <span>Rate a movie</span>
                <p>20 xp</p>
                <button onclick="completeMission('RateAMovie', 20)">Complete</button>
            </div>
            <div class="mission-card">
                <span>Like a movie</span>
                <p>20 xp</p>
                <button onclick="completeMission('LikeAMovie', 20)">Complete</button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            updateProgress();
        });

        function updateProgress() {
            const progressBarFill = document.getElementById("progress-bar-fill");
            const progressValue = document.getElementById("progress-value");
            const tierNumber = document.getElementById("tier-number");

            // Obter o valor atual de exp
            const currentExp = parseInt(progressValue.textContent.split(" / ")[0]);

            // Calcular o tier com base no exp
            const currentTier = Math.floor(currentExp / 1000) + 1;

            // Calcular o exp mínimo e máximo para o tier atual
            const tierMinExp = (currentTier - 1) * 1000;
            const tierMaxExp = currentTier * 1000;

            // Atualizar a barra de progresso e o tier
            const progressPercentage = ((currentExp - tierMinExp) / (tierMaxExp - tierMinExp)) * 100;
            progressBarFill.style.width = `${progressPercentage}%`;
            tierNumber.textContent = `Tier ${currentTier}`;
            progressValue.textContent = `${currentExp} / ${tierMaxExp}`;
        }

        function completeMission(missionName, points) {
            console.log("Completing mission:", missionName, "Points:", points);

            // Enviar os pontos para o backend
            fetch('/add-exp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ exp: points })
            })
            .then(response => response.text())
            .then(message => {
                if (message === "Exp added successfully") {
                    console.log("EXP successfully added for mission:", missionName);

                    // Atualizar a barra de progresso no frontend
                    const progressValue = document.getElementById("progress-value");
                    const currentExp = parseInt(progressValue.textContent.split(" / ")[0]) + points;

                    // Atualizar o texto de exp
                    progressValue.textContent = `${currentExp} / ${(Math.floor(currentExp / 1000) + 1) * 1000}`;

                    // Atualizar o progresso e o tier
                    updateProgress();
                } else {
                    console.error("Failed to add EXP for mission:", missionName);
                }
            })
            .catch(error => console.error("Error completing mission:", error));
        }
    </script>
</body>
</html>
