<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle Pass</title>
    <link rel="stylesheet" href="/css/battlepass.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" referrerpolicy="no-referrer">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
    <header class="top-nav">
        <div class="nav-left">
            <span class="logo-text">StreamFlix</span>
        </div>
        <div class="nav-right">
            <ul class="nav-menu">
                <li><a href="/home"><i class="fa-solid fa-house"></i> Home</a></li>
                <li><a href="/shop"><i class="fa-solid fa-cart-shopping"></i> Shop</a></li>
                <li><a href="/login"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></li>
            </ul>
            <span class="nav-icon" id="points">
                Points: <span th:text="${loggedUser != null ? loggedUser.points : 0}"></span>
            </span>
        </div>
    </header>
    <section class="banner">
        <div class="banner-content">
            <h1>Battle Pass Rewards</h1>
            <p>Unlock exclusive rewards as you progress through the tiers!</p>
        </div>
    </section>
    <div class="battle-pass-container">
        <div class="progress-bar-container">
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progress-bar-fill" style="width: 0%;"></div>
                <span class="progress-value" id="progress-value">0 / 1000</span>
            </div>
            <div class="tier-number" id="tier-number">Tier 1</div>
            <p id="progress-summary">Unlocked Tiers: 0 / 10</p>
        </div>
        <div class="tier-progress-horizontal">
            <!-- Dynamic Tier Rendering -->
            <div class="tier">
                <button class="reward" onclick="claimReward(1)">
                    <img src="/images/reward1.png" alt="Reward 1">
                </button>
                <button class="reward" onclick="claimReward(2)">
                    <img src="/images/reward2.png" alt="Reward 2">
                </button>
                <button class="reward" onclick="claimReward(3)">
                    <img src="/images/reward3.png" alt="Reward 3">
                </button>
                <button class="reward" onclick="claimReward(4)">
                    <img src="/images/reward4.png" alt="Reward 4">
                </button>
                <button class="reward" onclick="claimReward(5)">
                    <img src="/images/reward5.png" alt="Reward 5">
                </button>
                <button class="reward" onclick="claimReward(6)">
                    <img src="/images/reward6.png" alt="Reward 6">
                </button>
                <button class="reward" onclick="claimReward(7)">
                    <img src="/images/reward7.png" alt="Reward 7">
                </button>
                <button class="reward" onclick="claimReward(8)">
                    <img src="/images/reward8.png" alt="Reward 8">
                </button>
                <button class="reward" onclick="claimReward(9)">
                    <img src="/images/reward9.png" alt="Reward 9">
                </button>
                <button class="reward" onclick="claimReward(10)">
                    <img src="/images/reward10.png" alt="Reward 10">
                </button>
            </div>
        </div>
    </div>
    <div class="missions-container">
        <h2>Daily Missions</h2>
        <div class="missions-grid">
            <div class="mission-card">
                <span>Daily Login</span>
                <p>10 xp</p>
                <button onclick="completeMission('DailyLogin', 10)">Complete</button>
            </div>
            <div class="mission-card">
                <span>Watch 3 Movies</span>
                <p>50 xp</p>
                <button onclick="completeMission('Watch3Movies', 50)">Complete</button>
            </div>
            <div class="mission-card">
                <span>Buy something</span>
                <p>75 xp</p>
                <button onclick="completeMission('BuySomething', 75)">Complete</button>
            </div>
            <div class="mission-card">
                <span>Rate a movie</span>
                <p>20 xp</p>
                <button onclick="completeMission('RateAMovie', 20)">Complete</button>
            </div>
            <div class="mission-card">
                <span>Like a movie</span>
                <p>20 xp</p>
                <button onclick="completeMission('LikeAMovie', 20)">Complete</button>
            </div>
        </div>
    </div>
    <script>
        let currentTier = 1; // Start at Tier 1
        let currentPoints = 0; // Start with 0 points
        const maxPoints = 500; // 10 tiers * 100 points per tier
        const pointsPerTier = 50; // Points required to complete each tier

        function collectReward(tier) {
            const requiredPoints = (tier - 1) * pointsPerTier; // Calculate required points for the tier
            if (currentPoints >= requiredPoints) {
                if (tier === currentTier) {
                    currentPoints += pointsPerTier;
                    if (currentPoints >= maxPoints) {
                        currentPoints = maxPoints;
                        currentTier = 11; // Set to 11 to indicate all tiers are unlocked
                        launchConfetti(); // Trigger confetti effect
                    } else {
                        currentTier++;
                    }
                    updateProgress();
                } else {
                    alert("You need to unlock the current tier first!");
                }
            } else {
                alert(`You need ${requiredPoints} points to unlock Tier ${tier}!`);
            }
        }

        function updateProgress() {
            const progressBarFill = document.getElementById("progress-bar-fill");
            const progressValue = document.getElementById("progress-value");
            const tierNumber = document.getElementById("tier-number");
            const progressSummary = document.getElementById("progress-summary");

            const progressPercentage = (currentPoints / maxPoints) * 100;
            progressBarFill.style.width = `${progressPercentage}%`;
            progressValue.textContent = `${currentPoints} / ${maxPoints}`;
            tierNumber.textContent = `Tier ${Math.min(currentTier, 10)}`; // Display Tier 10 as the maximum
            progressSummary.textContent = `Unlocked Tiers: ${Math.min(currentTier - 1, 10)} / 10`; // Update to 10/10 when Tier 10 is unlocked
        }

        function launchConfetti() {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }

        function completeMission(missionName, points) {
            console.log("Completing mission:", missionName, "Points:", points); // Log for debugging
            currentPoints += points; // Increment points directly
            if (currentPoints >= maxPoints) {
                currentPoints = maxPoints;
                currentTier = 11; // Set to 11 to indicate all tiers are unlocked
                launchConfetti();
            } else {
                while (currentPoints >= currentTier * pointsPerTier && currentTier <= 10) {
                    currentTier++;
                }
            }
            updateProgress(); // Update progress bar and unlocked tiers
        }

        function claimReward(tier) {
            fetch(`/claimReward?tier=${tier}`, { method: 'POST' })
                .then(response => response.text())
                .then(message => {
                    if (message === "success") {
                        // Atualize a interface para mostrar que a recompensa foi redimida
                        console.log(`Reward for Tier ${tier} claimed successfully!`);
                        document.querySelector(`.reward[onclick="claimReward(${tier})"]`).classList.add("claimed");
                    } else if (message === "already_claimed") {
                        console.log(`Reward for Tier ${tier} has already been claimed.`);
                    } else if (message === "not_logged_in") {
                        console.log("User not logged in.");
                    } else if (message === "error") {
                        console.error("An error occurred while claiming the reward.");
                    }
                })
                .catch(error => console.error('Error claiming reward:', error));
        }

        // Initialize progress bar and tier display on page load
        document.addEventListener("DOMContentLoaded", () => {
            updateProgress();
        });
    </script>
</body>
</html>
