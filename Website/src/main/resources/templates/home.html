<!DOCTYPE html>
<html lang="en">
<head>
  
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>StreamFlix - Home</title>
  <!-- Font Awesome Icons -->
  <link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
  referrerpolicy="no-referrer"
  />

  <!-- CSS File -->
  <link rel="stylesheet" href="/css/home.css" />
</head>
<body>
  <!-- Back to Top Button -->
  <button id="back-to-top" title="Back to Top" aria-label="Back to Top">&#8679;</button>
  
  <!-- Introduction Modal -->
  <div id="intro-modal" class="modal">
    <div class="modal-content">
      <h2>Welcome to StreamFlix!</h2>
      <p>StreamFlix is your personalized movie streaming platform. To provide you with the best recommendations, we need to know your favorite genres. Please take a moment to complete the quick questionnaire.</p>
      <button id="intro-continue-btn">Continue</button>
    </div>
  </div>

 <!-- Popup Modal -->
<div id="questionnaire-modal" class="modal">
  <div class="modal-content">
    <h2>Quick Questionnaire</h2>
    <form id="questionnaire-form" method="post" action="/save-genres">
      <input type="hidden" name="userId" id="userId" />
      <label for="favorite-genres" class="form-label">Select your favorite genres:</label>
      <div id="genre-checkboxes" class="genre-grid">
        <div class="genre-column">
          <label><input type="checkbox" name="genres" value="Action" /> Action</label>
          <label><input type="checkbox" name="genres" value="Adventure" /> Adventure</label>
          <label><input type="checkbox" name="genres" value="Animation" /> Animation</label>
          <label><input type="checkbox" name="genres" value="Biography" /> Biography</label>
          <label><input type="checkbox" name="genres" value="Comedy" /> Comedy</label>
        </div>
        <div class="genre-column">
          <label><input type="checkbox" name="genres" value="Crime" /> Crime</label>
          <label><input type="checkbox" name="genres" value="Documentary" /> Documentary</label>
          <label><input type="checkbox" name="genres" value="Drama" /> Drama</label>
          <label><input type="checkbox" name="genres" value="Family" /> Family</label>
          <label><input type="checkbox" name="genres" value="Fantasy" /> Fantasy</label>
        </div>
        <div class="genre-column">
          <label><input type="checkbox" name="genres" value="Film-Noir" /> Film-Noir</label>
          <label><input type="checkbox" name="genres" value="Game-Show" /> Game-Show</label>
          <label><input type="checkbox" name="genres" value="History" /> History</label>
          <label><input type="checkbox" name="genres" value="Horror" /> Horror</label>
          <label><input type="checkbox" name="genres" value="Music" /> Music</label>
        </div>
        <div class="genre-column">
          <label><input type="checkbox" name="genres" value="Musical" /> Musical</label>
          <label><input type="checkbox" name="genres" value="Mystery" /> Mystery</label>
          <label><input type="checkbox" name="genres" value="News" /> News</label>
          <label><input type="checkbox" name="genres" value="Reality-TV" /> Reality-TV</label>
          <label><input type="checkbox" name="genres" value="Romance" /> Romance</label>
        </div>
        <div class="genre-column">
          <label><input type="checkbox" name="genres" value="Sci-Fi" /> Sci-Fi</label>
          <label><input type="checkbox" name="genres" value="Short" /> Short</label>
          <label><input type="checkbox" name="genres" value="Sport" /> Sport</label>
          <label><input type="checkbox" name="genres" value="Talk-Show" /> Talk-Show</label>
          <label><input type="checkbox" name="genres" value="Thriller" /> Thriller</label>
        </div>
        <div class="genre-column">
          <label><input type="checkbox" name="genres" value="War" /> War</label>
          <label><input type="checkbox" name="genres" value="Western" /> Western</label>
        </div>
      </div>
      <button type="submit" class="submit-btn">Submit</button>
    </form>
  </div>
</div>

  <!-- Netflix-style Top Nav -->
  <header class="top-nav" id="dynamic-menu">
    <div class="nav-left">
      <span class="logo-text">StreamFlix</span>
      <ul class="nav-menu">
        <li><a href="#"><i class="fa-solid fa-house"></i> Home</a></li>
        <li class="dropdown">
          <a href="/shop"><i class="fa-solid fa-cart-shopping"></i> Shop</a>
          <ul class="dropdown-menu">
            <li><a href="/shop#rewards">Rewards</a></li>
            <li><a href="/shop#offers">Special Offers</a></li>
          </ul>
        </li>
      </ul>
    </div>
    <div class="nav-right">
      <a href="/points-info" class="nav-icon"><i class="fa-solid fa-info-circle"></i> Points Info</a>
      <span class="nav-icon" id="points">
        Points: <span th:text="${session.loggedUser != null ? session.loggedUser.points : 0}"></span>
      </span>
      <a href="/login" class="nav-icon" id="logout"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
      <a href="/battlepass" class="nav-icon" id="battlepass"><i class="fa-solid fa-gift"></i> Battle Pass Rewards</a>
    </div>
  </header>
  


  <!-- Main Banner -->
  <section class="banner" id="dynamic-banner">
    <div class="video-background">
      <iframe
        src="https://www.youtube.com/embed/6ZfuNTqbHE8?autoplay=1&mute=1&loop=1&playlist=6ZfuNTqbHE8&controls=0&modestbranding=1&iv_load_policy=3&rel=0&disablekb=1&playsinline=1&showinfo=0&fs=0"
        frameborder="0"
        allow="autoplay; fullscreen"
        allowfullscreen
       
      ></iframe>
    </div>
    <div class="banner-content" id="banner-content">
      <h1>Avengers: Infinity War</h1>
      <p>The Avengers must stop Thanos, an intergalactic warlord, from acquiring all six Infinity Stones.</p>
      <a href="/movie" class="play-button">Play</a>
      <button>More Info</button>
    </div>
  </section>

  <!-- Section: Trending Now -->
  <section class="movies-section" th:if="${recommendations != null and !recommendations.isEmpty()}">
    <h2>Trending Now</h2>
    <div class="movie-list-wrapper">
      <button class="scroll-button left" onclick="scrollLeft(this)">&#8249;</button>
      <ul class="movie-list">
        <li class="movie-item" th:each="movie, iterStat : ${recommendations}" data-random-image>
          <div class="movie-thumbnail">
            <a href="/movie">
              <img th:alt="${movie['title']}" id="trending-image-${iterStat.index}" />
            </a>
          </div>
          <div class="movie-details">
            <h3 class="movie-title" th:text="${movie['title']}">Movie Title</h3>
            <p class="movie-info" th:text="'Rating: ' + ${movie['averageRating']} + ' | Year: ' + (${movie['releaseYear'] != null ? movie['releaseYear'] : 'Unknown'})">
              Rating: X.X | Year: YYYY
            </p>
          </div>
        </li>
      </ul>
      <button class="scroll-button right" onclick="scrollRight(this)">&#8250;</button>
    </div>
  </section>

  <!-- Error message if no preferences -->
  <div th:if="${recommendations == null or recommendations.isEmpty()}" class="error-message">
    <p>You have not defined your favorite movie genres. Please update your preferences to see recommendations.</p>
  </div>

  <!-- Display error message if present -->
  <div th:if="${error}" class="error-message">
    <p th:text="${error}"></p>
  </div>

  <!-- Section: Top Movies by Genre -->
  <section class="movies-by-genre" th:if="${topGenresMovies != null}" th:each="entry, iterStat : ${topGenresMovies}">
    <h2 th:text="'Top Movies in ' + ${entry.key}">Top Movies in Genre</h2>
    <div class="movie-list-wrapper">
      <button class="scroll-button left" onclick="scrollLeft(this)">&#8249;</button>
      <ul class="movie-list">
        <li class="movie-item" th:each="movie, movieStat : ${entry.value}" data-random-image>
          <div class="movie-thumbnail">
            <a href="/movie">
              <img th:alt="${movie['title']}" id="genre-image-${iterStat.index}-${movieStat.index}" />
            </a>
          </div>
          <div class="movie-details">
            <h3 class="movie-title" th:text="${movie['title']}">Movie Title</h3>
            <p class="movie-info" th:text="'Rating: ' + ${movie['averageRating']} + ' | Year: ' + (${movie['releaseYear'] != null ? movie['releaseYear'] : 'Unknown'})">
              Rating: X.X | Year: YYYY
            </p>
          </div>
        </li>
      </ul>
      <button class="scroll-button right" onclick="scrollRight(this)">&#8250;</button>
    </div>
  </section>

    <!-- Section: Least Preferred Movies -->
    <section class="movies-section" th:if="${leastPreferredRecommendations != null and !leastPreferredRecommendations.isEmpty()}">
      <h2>Other Movies</h2>
      <div class="movie-list-wrapper">
        <button class="scroll-button left" onclick="scrollLeft(this)">&#8249;</button>
        <ul class="movie-list">
          <li class="movie-item" th:each="movie, iterStat : ${leastPreferredRecommendations}" data-random-image>
            <div class="movie-thumbnail">
              <a href="/movie">
                <img th:alt="${movie['title']}" id="least-preferred-image-${iterStat.index}" />
              </a>
            </div>
            <div class="movie-details">
              <h3 class="movie-title" th:text="${movie['title']}">Movie Title</h3>
              <p class="movie-info" th:text="'Rating: ' + ${movie['averageRating']} + ' | Year: ' + (${movie['releaseYear'] != null ? movie['releaseYear'] : 'Unknown'})">
                Rating: X.X | Year: YYYY
              </p>
            </div>
          </li>
        </ul>
        <button class="scroll-button right" onclick="scrollRight(this)">&#8250;</button>
      </div>
    </section>

  <!-- Script to dynamically extract the dominant color of the image and apply it as the border color on hover -->
  <script>
    document.querySelectorAll('.movie-card img').forEach((img) => {
      img.addEventListener('mouseenter', () => {
        const colorThief = new ColorThief();
        if (img.complete) {
          const dominantColor = colorThief.getColor(img);
          img.style.borderColor = `rgb(${dominantColor.join(',')})`; // Apply dominant color to border
        }
      });
      img.addEventListener('mouseleave', () => {
        img.style.borderColor = 'transparent'; // Reset border color
      });
    });

// Mostrar o modal automaticamente se o parâmetro "showQuestionnaire" estiver na URL
window.onload = function () {
  const urlParams = new URLSearchParams(window.location.search);
  const userId = urlParams.get('userId');
  const isFirstTime = urlParams.get('firstTime') === 'true'; // Check if it's the first time

  if (isFirstTime) {
    const introModal = document.getElementById('intro-modal');
    introModal.style.display = 'block';

    document.getElementById('intro-continue-btn').onclick = function () {
      introModal.style.display = 'none';
      if (userId) {
        document.getElementById('userId').value = userId;
        const questionnaireModal = document.getElementById('questionnaire-modal');
        questionnaireModal.style.display = 'block';
      }
    };
  } else if (userId) {
    document.getElementById('userId').value = userId;
    const questionnaireModal = document.getElementById('questionnaire-modal');
    questionnaireModal.style.display = 'block';
  }
};

// Remover a funcionalidade de fechar o modal ao clicar fora dele
window.onclick = function (event) {
  const modal = document.getElementById('questionnaire-modal');
  if (event.target === modal) {
    alert('You must complete the questionnaire to proceed.');
  }
};

// Handle form submission
document.getElementById('questionnaire-form').onsubmit = (e) => {
  e.preventDefault();
  const selectedGenres = document.querySelectorAll('input[name="genres"]:checked');
  if (selectedGenres.length < 3) {
    alert('Please select at least 3 genres.');
    return;
  }
  // Submeter o formulário
  e.target.submit();
};

  function scrollLeft(button) {
    const wrapper = button.parentElement.querySelector('.movie-list');
    wrapper.scrollBy({ left: -wrapper.offsetWidth, behavior: 'smooth' }); // Scroll left by the width of the container
  }

  function scrollRight(button) {
    const wrapper = button.parentElement.querySelector('.movie-list');
    wrapper.scrollBy({ left: wrapper.offsetWidth, behavior: 'smooth' }); // Scroll right by the width of the container
  }

  // Film images using API of TMDB 
  const apiKey = '8a005d935acdd9a393df2d9bc8e10e79';
  const baseImageUrl = 'https://image.tmdb.org/t/p/w500';

  // Array of random image URLs from the imageMovies folder
  const randomImages = [
    '/imagesMovies/8.0_84654.jpg',
    '/imagesMovies/8.0_84740.jpg',
    '/imagesMovies/8.0_88247.jpg',
    '/imagesMovies/8.0_88258.jpg',
    '/imagesMovies/8.0_88846.jpg',
    '/imagesMovies/8.0_91167.jpg',
    '/imagesMovies/8.0_91480.jpg',
    '/imagesMovies/8.0_95953.jpg',
    '/imagesMovies/8.0_96028.jpg',
    '/imagesMovies/8.0_97123.jpg',
    '/imagesMovies/8.0_97165.jpg',
    '/imagesMovies/8.0_99028.jpg',
    '/imagesMovies/8.0_99348.jpg',
    '/imagesMovies/8.1_100332.jpg',
    '/imagesMovies/8.1_10323.jpg',
    '/imagesMovies/8.1_106332.jpg',
    '/imagesMovies/8.1_107290.jpg',
    '/imagesMovies/8.1_107472.jpg',
    '/imagesMovies/8.1_109424.jpg',
    '/imagesMovies/8.1_110882.jpg',
    '/imagesMovies/8.1_111495.jpg',
    '/imagesMovies/8.1_112373.jpg',
    '/imagesMovies/8.1_112471.jpg',
    '/imagesMovies/8.1_113247.jpg',
    '/imagesMovies/8.1_114787.jpg',
    '/imagesMovies/8.1_116282.jpg',
    '/imagesMovies/8.1_116506.jpg',
    '/imagesMovies/8.1_117907.jpg',
    '/imagesMovies/8.1_118694.jpg',
    '/imagesMovies/8.1_118843.jpg',
    '/imagesMovies/8.1_120382.jpg',
    '/imagesMovies/8.1_120731.jpg',
    '/imagesMovies/8.1_12364.jpg',
    '/imagesMovies/8.1_145046.jpg',
    '/imagesMovies/8.1_15064.jpg',
    '/imagesMovies/8.1_154420.jpg',
    '/imagesMovies/8.1_167404.jpg',
    '/imagesMovies/8.1_16847.jpg',
    '/imagesMovies/8.1_168515.jpg',
    '/imagesMovies/8.1_198781.jpg',
    '/imagesMovies/8.1_20629.jpg',
    '/imagesMovies/8.1_221344.jpg',
    '/imagesMovies/8.1_23042.jpg',
    '/imagesMovies/8.1_24069.jpg',
    '/imagesMovies/8.1_243664.jpg',
    '/imagesMovies/8.1_244316.jpg',
    '/imagesMovies/8.1_245712.jpg',
    '/imagesMovies/8.1_25878.jpg',
    '/imagesMovies/8.1_264464.jpg',
    '/imagesMovies/8.1_266543.jpg',
    '/imagesMovies/8.1_266697.jpg',
    '/imagesMovies/8.1_27532.jpg',
    '/imagesMovies/8.1_276919.jpg',
    '/imagesMovies/8.1_28010.jpg',
    '/imagesMovies/8.1_28950.jpg',
    '/imagesMovies/8.1_307385.jpg',
    '/imagesMovies/8.1_31885.jpg',
    '/imagesMovies/8.1_32138.jpg',
    '/imagesMovies/8.1_32551.jpg',
    '/imagesMovies/8.1_33045.jpg',
    '/imagesMovies/8.1_338564.jpg',
    '/imagesMovies/8.1_34240.jpg',
    '/imagesMovies/8.1_35140.jpg',
    '/imagesMovies/8.1_36244.jpg',
    '/imagesMovies/8.1_36868.jpg',
    '/imagesMovies/8.1_37008.jpg',
    '/imagesMovies/8.1_374546.jpg',
    '/imagesMovies/8.1_37558.jpg',
    '/imagesMovies/8.1_379557.jpg',
    '/imagesMovies/8.1_38190.jpg',
    '/imagesMovies/8.1_38733.jpg',
    '/imagesMovies/8.1_38890.jpg',
    '/imagesMovies/8.1_39689.jpg',
    '/imagesMovies/8.1_41546.jpg',
    '/imagesMovies/8.1_41719.jpg',
    '/imagesMovies/8.1_44008.jpg',
    '/imagesMovies/8.1_44837.jpg',
    '/imagesMovies/8.1_46250.jpg',
    '/imagesMovies/8.1_46911.jpg',
    '/imagesMovies/8.1_47528.jpg',
    '/imagesMovies/8.1_49012.jpg',
    '/imagesMovies/8.1_51459.jpg',
    '/imagesMovies/8.1_51808.jpg',
    '/imagesMovies/8.1_52561.jpg',
    '/imagesMovies/8.1_52600.jpg',
    '/imagesMovies/8.1_52618.jpg',
    '/imagesMovies/8.1_53198.jpg',
    '/imagesMovies/8.1_53779.jpg',
    '/imagesMovies/8.1_54460.jpg',
    '/imagesMovies/8.1_55499.jpg',
    '/imagesMovies/8.1_56217.jpg',
    '/imagesMovies/8.1_56241.jpg',
    '/imagesMovies/8.1_56663.jpg',
    '/imagesMovies/8.1_56687.jpg',
    '/imagesMovies/8.1_56801.jpg',
    '/imagesMovies/8.1_57058.jpg',
    '/imagesMovies/8.1_57091.jpg',
    '/imagesMovies/8.1_57358.jpg',
    '/imagesMovies/8.1_58946.jpg',
    '/imagesMovies/8.1_59527.jpg'
];

  function assignRandomImage(movieElement) {
    const randomIndex = Math.floor(Math.random() * randomImages.length);
    movieElement.src = randomImages[randomIndex];
  }

  function fetchMovieImage(movieTitle, movieElement) {
    if (!movieTitle || !movieElement) return;

    fetch(`https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(movieTitle)}`)
      .then(response => response.json())
      .then(data => {
        if (data.results && data.results.length > 0) {
          const movie = data.results[0];
          const imageUrl = movie.poster_path ? baseImageUrl + movie.poster_path : null;
          if (imageUrl) {
            movieElement.src = imageUrl; // Replace random image with API image
          }
        } else {
          console.error('Imagem não encontrada para o filme:', movieTitle);
        }
      })
      .catch(error => {
        console.error('Erro ao buscar imagem:', error);
      });
  }

  // Assign random images first
  document.querySelectorAll('.movies-section .movie-item').forEach(movieItem => {
    const imgElement = movieItem.querySelector('img');
    assignRandomImage(imgElement);
  });

  document.querySelectorAll('.movies-by-genre .movie-item').forEach(movieItem => {
    const imgElement = movieItem.querySelector('img');
    assignRandomImage(imgElement);
  });

  // Fetch and replace images from TMDB API
  document.querySelectorAll('.movies-section .movie-item').forEach(movieItem => {
    const movieTitle = movieItem.querySelector('.movie-title')?.innerText;
    const imgElement = movieItem.querySelector('img');
    fetchMovieImage(movieTitle, imgElement);
  });

  document.querySelectorAll('.movies-by-genre .movie-item').forEach(movieItem => {
    const movieTitle = movieItem.querySelector('.movie-title')?.innerText;
    const imgElement = movieItem.querySelector('img');
    fetchMovieImage(movieTitle, imgElement);
  });

  // Ensure fallback images are applied after fetching
  setTimeout(() => {
    document.querySelectorAll('.movies-section .movie-item img').forEach(imgElement => {
      if (!imgElement.src || imgElement.src.includes('/images/default-movie-poster.jpg')) {
        assignRandomImage(imgElement);
      }
    });

    document.querySelectorAll('.movies-by-genre .movie-item img').forEach(imgElement => {
      if (!imgElement.src || imgElement.src.includes('/images/default-movie-poster.jpg')) {
        assignRandomImage(imgElement);
      }
    });
  }, 5000);

  // Back to Top Button Functionality
  const backToTopButton = document.getElementById('back-to-top');
  window.onscroll = function () {
    if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
      backToTopButton.style.display = 'block';
    } else {
      backToTopButton.style.display = 'none';
    }
  };

  backToTopButton.onclick = function () {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };
</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>
</body>
</html>
