<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop</title>
    <link rel="stylesheet" type="text/css" href="/css/shop.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" referrerpolicy="no-referrer" />
    <style>
        /* Ensure all images have the same size */
        .grid .card img {
            width: 200px;
            height: 300px;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <header class="top-nav">
        <div class="nav-left">
            <span class="logo-text">StreamFlix</span>
            <a href="/home" class="button">Home</a>
        </div>
        <div class="nav-right">
            <a href="/points-info" class="nav-icon"><i class="fa-solid fa-info-circle"></i> Points Info</a>
            <span class="nav-icon">Points: <span th:text="${session.loggedUser != null ? session.loggedUser.points : 0}"></span></span>
            <a href="/battlepass" class="nav-icon"><i class="fa-solid fa-gift"></i> Battle Pass Rewards</a>
            <a href="/login" class="nav-icon"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
        </div>
    </header>

    <div class="banner">
        <h1>Win Exclusive Rewards!</h1>
        <p>Trade your points for rewards.</p>
    </div>
    <div class="countdown">
        <p>Next shop refresh in: <span id="countdown"></span></p>
    </div>
    <div class="container" id="rewards">
        <h2>Available Amazon Products</h2>
        <div class="grid">
            <div class="card" th:each="product : ${shop.products}">
                <img th:alt="${product.productName}" id="product-image-${product.id}" src="https://via.placeholder.com/300" />
                <h3 th:text="${product.productName}">Product Name</h3>
                <p th:text="${product.category}">Category</p>
                <span class="points" th:text="'Cost: ' + ${product.cost} + ' points'">Cost and Points</span>
                <a href="#" class="button" th:if="${product.isRedeemed == false}" 
                   th:attr="data-product-id=${product.id}" onclick="redeemProduct(this)">Redeem</a>
                <span th:if="${product.isRedeemed == true}">Already redeemed</span>
            </div>
        </div>
    </div>

    <div class="container" id="recommended-movies">
        <h2>Available Movies</h2>
        <div class="grid">
            <div class="card" th:each="movie : ${shop.movies}">
                <img th:alt="${movie.title}" id="movie-image-${movie.id}" src="https://via.placeholder.com/300" />
                <h3 th:text="${movie.title}">Movie Title</h3>
                <p th:text="${movie.genres}">Genres</p>
                <span class="points" th:text="'Rating: ' + ${movie.averageRating}">Average Rating</span>
                <p th:text="'Release Year: ' + ${movie.releaseYear}">Release Year</p>
                <span class="points">Cost: 999 points</span>
                <a href="#" class="button" th:if="${movie.isRedeemed == false}" 
                   th:attr="data-movie-id=${movie.id}" onclick="redeemMovie(this)">Redeem</a>
                <span th:if="${movie.isRedeemed == true}">Already redeemed</span>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const countdownElement = document.getElementById('countdown');
        const nextRefreshTime = new Date(/*[[${countdownDate}]]*/ '2025-04-08T03:04:05').getTime(); // Ensure valid ISO 8601 format

        function updateCountdown() {
            const now = new Date().getTime();
            const timeLeft = nextRefreshTime - now;

            if (timeLeft <= 0) {
                countdownElement.textContent = "Shop is refreshing...";
                return;
            }

            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            countdownElement.textContent = `${days} days, ${hours} hours, ${minutes} minutes, ${seconds} seconds`;
        }

        setInterval(updateCountdown, 1000);
        updateCountdown();
    </script>

    <script>
        const apiKey = '50ce0-20'; // Amazon Product Advertising API key
        const affiliateBaseUrl = 'https://webservices.amazon.com/paapi5/getitems';
        const amazonRandomImages = [
            '/imagesamazon/unnamed.jpg',
            '/imagesAmazon/product2.jpg',
            '/imagesAmazon/product3.jpg',
            '/imagesAmazon/product4.jpg',
            '/imagesAmazon/product5.jpg',
            '/imagesAmazon/product6.jpg',
            '/imagesAmazon/product7.jpg',
            '/imagesAmazon/product8.jpg',
            '/imagesAmazon/product9.jpg',
            '/imagesAmazon/product10.jpg'
        ];

        function assignRandomAmazonImage(productElement) {
            const randomIndex = Math.floor(Math.random() * amazonRandomImages.length);
            productElement.src = amazonRandomImages[randomIndex];
        }

        async function fetchAmazonRewardImage(productName, productElement) {
            if (!productName || !productElement) return;

            try {
                const response = await fetch(affiliateBaseUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey
                    },
                    body: JSON.stringify({
                        Keywords: productName,
                        Resources: ['Images.Primary.Medium']
                    })
                });

                if (!response.ok) {
                    console.error('Failed to fetch product image:', response.statusText);
                    assignRandomAmazonImage(productElement); // Use random image as fallback
                    return;
                }

                const data = await response.json();
                if (data.ItemsResult && data.ItemsResult.Items && data.ItemsResult.Items.length > 0) {
                    const product = data.ItemsResult.Items[0];
                    const imageUrl = product.Images?.Primary?.Medium?.URL;
                    if (imageUrl) {
                        productElement.src = imageUrl; // Set API image
                    } else {
                        assignRandomAmazonImage(productElement); // Use random image as fallback
                    }
                } else {
                    assignRandomAmazonImage(productElement); // Use random image as fallback
                }
            } catch (error) {
                console.error('Error fetching Amazon reward image:', error);
                assignRandomAmazonImage(productElement); // Use random image as fallback
            }
        }

        document.querySelectorAll('#rewards .card').forEach(card => {
            const productName = card.querySelector('h3')?.innerText;
            const imgElement = card.querySelector('img');
            fetchAmazonRewardImage(productName, imgElement);
        });

        const tmdbApiKey = '8a005d935acdd9a393df2d9bc8e10e79'; // TMDB API key
        const tmdbBaseImageUrl = 'https://image.tmdb.org/t/p/w500';
        const randomImages = [
            '/imagesMovies/8.0_84654.jpg',
            '/imagesMovies/8.0_84740.jpg',
            '/imagesMovies/8.0_88247.jpg',
            '/imagesMovies/8.0_88258.jpg',
            '/imagesMovies/8.0_88846.jpg',
            '/imagesMovies/8.0_91167.jpg',
            '/imagesMovies/8.0_91480.jpg',
            '/imagesMovies/8.0_95953.jpg',
            '/imagesMovies/8.0_96028.jpg',
            '/imagesMovies/8.0_97123.jpg'
        ];

        function assignRandomImage(movieElement) {
            const randomIndex = Math.floor(Math.random() * randomImages.length);
            movieElement.src = randomImages[randomIndex];
        }

        function fetchMovieImage(movieTitle, movieElement) {
            if (!movieTitle || !movieElement) return;

            fetch(`https://api.themoviedb.org/3/search/movie?api_key=${tmdbApiKey}&query=${encodeURIComponent(movieTitle)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.results && data.results.length > 0) {
                        const movie = data.results[0];
                        const imageUrl = movie.poster_path ? tmdbBaseImageUrl + movie.poster_path : null;
                        if (imageUrl) {
                            movieElement.src = imageUrl; // Set API image
                        } else {
                            assignRandomImage(movieElement); // Use random image as fallback
                        }
                    } else {
                        assignRandomImage(movieElement); // Use random image as fallback
                    }
                })
                .catch(error => {
                    console.error('Error fetching movie image:', error);
                    assignRandomImage(movieElement); // Use random image as fallback
                });
        }

        document.querySelectorAll('#recommended-movies .card').forEach(card => {
            const movieTitle = card.querySelector('h3')?.innerText;
            const imgElement = card.querySelector('img');
            fetchMovieImage(movieTitle, imgElement);
        });

        function redeemProduct(element) {
            const productId = element.getAttribute('data-product-id');
            fetch('/redeem-product', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ productId })
            }).then(response => response.text())
              .then(alert)
              .then(() => location.reload());
        }

        function redeemMovie(element) {
            const movieId = element.getAttribute('data-movie-id');
            fetch('/redeem-movie', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ movieId })
            }).then(response => response.text())
              .then(alert)
              .then(() => location.reload());
        }
    </script>
</body>
</html>