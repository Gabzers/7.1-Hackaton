<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StreamFlix - Watch Movie</title>
  <link rel="stylesheet" href="/css/movie.css" />
</head>
<body>
  <header class="top-nav" role="banner">
    <a href="/home" class="home-button" aria-label="Go back to home">
      &#8592; Home
    </a>
  </header>
  <main class="movie-container" role="main">
    <div class="movie-player-wrapper">
      <div id="ad-container" class="movie-player" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; background-color: black;">
        <iframe
          id="ad-frame"
          src=""
          allow="autoplay; fullscreen"
          allowfullscreen
          aria-label="Ad player"
          style="width: 100%; height: 100%; border: none;"
        ></iframe>
        <button id="skip-ad-button" style="display: none; position: absolute; bottom: 10px; right: 10px; background-color: rgba(0, 0, 0, 0.7); color: white; border: none; padding: 10px; cursor: pointer; border-radius: 5px;">
          Skip Ad (<span id="ad-countdown">6</span>)
        </button>
      </div>
      <div class="movie-player" id="movie-player-container">
        <div id="loading-spinner" class="loading-spinner" aria-hidden="true"></div>
        <iframe
          id="movie-frame"
          src="https://www.youtube.com/embed/6ZfuNTqbHE8?enablejsapi=1&modestbranding=1&rel=0&controls=0&showinfo=0"
          allow="autoplay; fullscreen"
          allowfullscreen
          aria-label="Movie player"
        ></iframe>
      </div>
      <div class="rating-container" aria-label="Rate this video" style="display: none;" id="rating-container">
        <span class="rating-label">Rate this movie:</span>
        <div class="star-rating">
          <input type="radio" id="star5" name="rating" value="5" />
          <label for="star5" title="5 stars">★</label>
          <input type="radio" id="star4" name="rating" value="4" />
          <label for="star4" title="4 stars">★</label>
          <input type="radio" id="star3" name="rating" value="3" />
          <label for="star3" title="3 stars">★</label>
          <input type="radio" id="star2" name="rating" value="2" />
          <label for="star2" title="2 stars">★</label>
          <input type="radio" id="star1" name="rating" value="1" />
          <label for="star1" title="1 star">★</label>
        </div>
      </div>
    </div>
    <!-- Popup notification -->
    <div id="points-popup" style="display: none; position: fixed; top: 10%; left: 50%; transform: translate(-50%, 0); background-color: rgba(0, 0, 0, 0.8); color: white; padding: 20px; border-radius: 10px; border: 2px solid white; z-index: 3000; text-align: center; font-size: 1.2em;">
      Points added!
    </div>
  </main>
  
  <script>
    let player;
    let adCountdownInterval;
    let videoPlaying = false;
    let delayInterval;
    let ratingGiven = false; // Track if the user has already rated

    const ads = [
      { url: 'https://www.youtube.com/embed/rIUOFcHKvAU?autoplay=1&controls=0', duration: 6 },
      { url: 'https://www.youtube.com/embed/nLwML2PagbY?autoplay=1&controls=0', duration: 6 }
    ];

    function waitForDelay(seconds, callback) {
      let remaining = seconds;
      delayInterval = setInterval(() => {
        if (videoPlaying) {
          remaining--;
          if (remaining <= 0) {
            clearInterval(delayInterval);
            callback();
          }
        }
      }, 1000);
    }

    function showAd(adIndex, onAdComplete) {
      const adContainer = document.getElementById('ad-container');
      const adFrame = document.getElementById('ad-frame');
      const skipAdButton = document.getElementById('skip-ad-button');
      const adCountdown = document.getElementById('ad-countdown');

      adContainer.style.display = 'block';
      adFrame.src = ads[adIndex].url;
      skipAdButton.style.display = 'none';
      adCountdown.textContent = ads[adIndex].duration;

      let countdown = ads[adIndex].duration;
      adCountdownInterval = setInterval(() => {
        countdown--;
        adCountdown.textContent = countdown > 0 ? countdown : '0'; // Update countdown
        if (countdown <= 0) {
          clearInterval(adCountdownInterval);
          skipAdButton.style.display = 'block'; // Show skip button
        }
      }, 1000);

      // Ensure the skip button is displayed after the countdown ends
      setTimeout(() => {
        skipAdButton.style.display = 'block';
      }, ads[adIndex].duration * 1000);

      skipAdButton.onclick = () => {
        clearInterval(adCountdownInterval);
        adContainer.style.display = 'none';
        adFrame.src = '';

        // Send a request to the server to add 10 points to the user
        addPoints(10);

        onAdComplete(); // Resume the main video
      };
    }

    // Load the YouTube IFrame API
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('movie-frame', {
        events: {
          onReady: onPlayerReady,
          onStateChange: onPlayerStateChange,
        },
      });
    }

    // Show loading spinner until the video is ready
    function onPlayerStateChange(event) {
      const spinner = document.getElementById('loading-spinner');
      if (event.data === YT.PlayerState.BUFFERING) {
        spinner.style.display = 'block';
      } else {
        spinner.style.display = 'none';
      }

      // Update videoPlaying state based on player state
      if (event.data === YT.PlayerState.PLAYING) {
        videoPlaying = true;
      } else {
        videoPlaying = false;
      }
    }

    // Initialize controls when the player is ready
    function onPlayerReady(event) {
      const moviePlayerContainer = document.getElementById('movie-player-container');
      const ratingContainer = document.getElementById('rating-container');
      const starInputs = document.querySelectorAll('.star-rating input');

      // Toggle play/pause when the iframe container is clicked
      moviePlayerContainer.addEventListener('click', () => {
        const isPlaying = player.getPlayerState() === YT.PlayerState.PLAYING;
        if (isPlaying) {
          player.pauseVideo();
        } else {
          player.playVideo();
        }
      });

      // Force the video to start playing immediately
      player.playVideo();

      // Show the rating option after 30 seconds
      waitForDelay(30, () => {
        ratingContainer.style.display = 'block';
      });

      // Handle rating submission
      starInputs.forEach((input) => {
        input.addEventListener('change', () => {
          if (!ratingGiven) {
            ratingGiven = true; // Prevent multiple ratings
            ratingContainer.style.display = 'none'; // Hide the rating container after rating
            addPoints(5); // Add 5 points and show popup
          }
        });
      });

      // Handle ads
      waitForDelay(4, () => {
        videoPlaying = false; // Ensure the video is paused for the ad
        player.pauseVideo(); // Pause the video for the first ad
        showAd(0, () => {
          videoPlaying = true; // Resume video state
          player.playVideo(); // Resume the video after the first ad
          waitForDelay(24, () => {
            videoPlaying = false; // Ensure the video is paused for the second ad
            player.pauseVideo(); // Pause the video for the second ad
            showAd(1, () => {
              videoPlaying = true; // Resume video state
              player.playVideo(); // Resume the video after the second ad
            });
          });
        });
      });
    }

    function showPointsPopup(points) {
      const popup = document.getElementById('points-popup');
      popup.textContent = `${points} points added!`;
      popup.style.display = 'block';
      setTimeout(() => {
        popup.style.display = 'none';
      }, 2000); // Show popup for 2 seconds
    }

    function addPoints(points) {
      fetch('/add-points', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ points }),
      }).then((response) => {
        if (response.ok) {
          console.log(`${points} points added to the user.`);
          showPointsPopup(points); // Show popup notification
        } else {
          console.error('Failed to add points.');
        }
      });
    }

    // Load the YouTube IFrame API script
    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
  </script>
</body>
</html>
