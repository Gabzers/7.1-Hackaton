<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StreamFlix - Watch Movie</title>
  <link rel="stylesheet" href="/css/movie.css" />
</head>
<body>
  <header class="top-nav" role="banner">
    <a href="/home" class="home-button" aria-label="Go back to home">
      &#8592; Home
    </a>
  </header>
  <main class="movie-container" role="main">
    <div class="movie-player-wrapper">
      <div id="ad-container" class="movie-player" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; background-color: black;">
        <iframe
          id="ad-frame"
          src=""
          allow="autoplay; fullscreen"
          allowfullscreen
          aria-label="Ad player"
          style="width: 100%; height: 100%; border: none;"
        ></iframe>
        <button id="skip-ad-button" style="display: none; position: absolute; bottom: 10px; right: 10px; background-color: rgba(0, 0, 0, 0.7); color: white; border: none; padding: 10px; cursor: pointer; border-radius: 5px;">
          Skip Ad (<span id="ad-countdown">6</span>)
        </button>
      </div>
      <div class="movie-player" id="movie-player-container">
        <div id="loading-spinner" class="loading-spinner" aria-hidden="true"></div>
        <iframe
          id="movie-frame"
          src="https://www.youtube.com/embed/6ZfuNTqbHE8?enablejsapi=1&modestbranding=1&rel=0&controls=0&showinfo=0"
          allow="autoplay; fullscreen"
          allowfullscreen
          aria-label="Movie player"
        ></iframe>
      </div>
      <div class="video-controls">
        <button id="backward-button" aria-label="Rewind 10 seconds">⏪ Rewind 10s</button>
        <button id="forward-button" aria-label="Forward 10 seconds">Forward 10s ⏩</button>
        <button id="fullscreen-button" aria-label="Toggle fullscreen">⛶ Fullscreen</button>
        <input id="volume-slider" type="range" min="0" max="100" value="50" aria-label="Volume control" />
      </div>
      <div class="rating-container" aria-label="Rate this video">
        <span class="rating-label">Rate this movie:</span>
        <div class="star-rating">
          <input type="radio" id="star5" name="rating" value="5" />
          <label for="star5" title="5 stars">★</label>
          <input type="radio" id="star4" name="rating" value="4" />
          <label for="star4" title="4 stars">★</label>
          <input type="radio" id="star3" name="rating" value="3" />
          <label for="star3" title="3 stars">★</label>
          <input type="radio" id="star2" name="rating" value="2" />
          <label for="star2" title="2 stars">★</label>
          <input type="radio" id="star1" name="rating" value="1" />
          <label for="star1" title="1 star">★</label>
        </div>
      </div>
    </div>
  </main>
  
  <script>
    let player;
    let adCountdownInterval;
    let videoPlaying = false;
    let delayInterval;

    const ads = [
      { url: 'https://www.youtube.com/embed/rIUOFcHKvAU?autoplay=1&controls=0', duration: 6 },
      { url: 'https://www.youtube.com/embed/nLwML2PagbY?autoplay=1&controls=0', duration: 6 }
    ];

    function waitForDelay(seconds, callback) {
      let remaining = seconds;
      delayInterval = setInterval(() => {
        if (videoPlaying) {
          remaining--;
          if (remaining <= 0) {
            clearInterval(delayInterval);
            callback();
          }
        }
      }, 1000);
    }

    function showAd(adIndex, onAdComplete) {
      const adContainer = document.getElementById('ad-container');
      const adFrame = document.getElementById('ad-frame');
      const skipAdButton = document.getElementById('skip-ad-button');
      const adCountdown = document.getElementById('ad-countdown');

      adContainer.style.display = 'block';
      adFrame.src = ads[adIndex].url;
      skipAdButton.style.display = 'none';
      adCountdown.textContent = ads[adIndex].duration;

      let countdown = ads[adIndex].duration;
      adCountdownInterval = setInterval(() => {
        countdown--;
        adCountdown.textContent = countdown > 0 ? countdown : '0'; // Update countdown
        if (countdown <= 0) {
          clearInterval(adCountdownInterval);
          skipAdButton.style.display = 'block'; // Show skip button
        }
      }, 1000);

      // Ensure the skip button is displayed after the countdown ends
      setTimeout(() => {
        skipAdButton.style.display = 'block';
      }, ads[adIndex].duration * 1000);

      skipAdButton.onclick = () => {
        clearInterval(adCountdownInterval);
        adContainer.style.display = 'none';
        adFrame.src = '';
        onAdComplete(); // Resume the main video
      };
    }

    // Load the YouTube IFrame API
    function onYouTubeIframeAPIReady() {
      player = new YT.Player('movie-frame', {
        events: {
          onReady: onPlayerReady,
          onStateChange: onPlayerStateChange,
        },
      });
    }

    // Show loading spinner until the video is ready
    function onPlayerStateChange(event) {
      const spinner = document.getElementById('loading-spinner');
      if (event.data === YT.PlayerState.BUFFERING) {
        spinner.style.display = 'block';
      } else {
        spinner.style.display = 'none';
      }

      // Update videoPlaying state based on player state
      if (event.data === YT.PlayerState.PLAYING) {
        videoPlaying = true;
      } else {
        videoPlaying = false;
      }
    }

    // Initialize controls when the player is ready
    function onPlayerReady(event) {
      const volumeSlider = document.getElementById('volume-slider');
      const backwardButton = document.getElementById('backward-button');
      const forwardButton = document.getElementById('forward-button');
      const fullscreenButton = document.getElementById('fullscreen-button');
      const moviePlayerContainer = document.getElementById('movie-player-container');

      volumeSlider.addEventListener('input', (e) => player.setVolume(e.target.value));
      backwardButton.addEventListener('click', () => {
        const currentTime = player.getCurrentTime();
        player.seekTo(Math.max(0, currentTime - 10), true); // Skip backward 10 seconds
      });
      forwardButton.addEventListener('click', () => {
        const currentTime = player.getCurrentTime();
        player.seekTo(currentTime + 10, true); // Skip forward 10 seconds
      });

      fullscreenButton.addEventListener('click', () => {
        if (moviePlayerContainer.requestFullscreen) {
          moviePlayerContainer.requestFullscreen();
        } else if (moviePlayerContainer.webkitRequestFullscreen) { // Safari
          moviePlayerContainer.webkitRequestFullscreen();
        } else if (moviePlayerContainer.msRequestFullscreen) { // IE/Edge
          moviePlayerContainer.msRequestFullscreen();
        }
      });

      // Toggle play/pause when the iframe container is clicked
      moviePlayerContainer.addEventListener('click', () => {
        const isPlaying = player.getPlayerState() === YT.PlayerState.PLAYING;
        if (isPlaying) {
          player.pauseVideo();
        } else {
          player.playVideo();
        }
      });

      // Force the video to start playing immediately
      player.playVideo();

      // Handle ads
      waitForDelay(4, () => {
        videoPlaying = false; // Ensure the video is paused for the ad
        player.pauseVideo(); // Pause the video for the first ad
        showAd(0, () => {
          videoPlaying = true; // Resume video state
          player.playVideo(); // Resume the video after the first ad
          waitForDelay(24, () => {
            videoPlaying = false; // Ensure the video is paused for the second ad
            player.pauseVideo(); // Pause the video for the second ad
            showAd(1, () => {
              videoPlaying = true; // Resume video state
              player.playVideo(); // Resume the video after the second ad
            });
          });
        });
      });
    }

    // Load the YouTube IFrame API script
    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
  </script>
</body>
</html>
